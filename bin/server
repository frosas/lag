#!/bin/bash

set -ex

source $(dirname $0)/common

trap "exit" SIGINT
trap "kill 0" EXIT

web_server="forever src/server/http.js"
    
if [[ $is_dev ]]; then
  # TODO `webpack --watch` seems to trigger more often than needed when nodemon 
  # is watching it
  nodemon -q -w "webpack.config.js" -w "src/build" -w "src/universal" -x "webpack --watch" &
  nodemon -q -w "src" -w "test" -x "eslint . --fix" &
  nodemon -q -w "src" -w "test" -x "mocha 'test/**/*.js'" &
  nodemon -q -w "src/server" -w "src/universal" -x "$web_server" &
else
  $web_server &
fi

wait